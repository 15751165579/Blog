# 字典内部构造

  字典在Redis中应用非常广泛，例如我们前面提到的设置过期时间的key都会放进一个字典中、整个Redis中的key和value也组成了一个全局的字典。。。

### 字典的内部结构

  字典内部包含两个hashtable，通常情况下只有一个hashtable有值，但是在扩容和缩容的情况下，进行渐进式迁移，这时候两个hashtable分别存储新旧内容，搬迁结束则删除旧的hashtable。

```js
  ++++++++++++++++++
  + ht[0] + ht[1]  +
  ++++++++++++++++++
```

  hashtable是由数组和链表组成的，数组中存储链表中第一个元素的指针。

### 扩容

  大字典的扩容需要重新申请内存空间，然后将旧字典链表中的元素挂接到新的数组下面，这是一个O(n)操作，单线程的Redis承受不起这样的代价，采用渐进式rehash的小步搬迁。

  在rehash的过程中，字典的许多操作都需要在两个hashtable上进行，另外在rehash的过程中新的元素一律添加在新的hashtable中，旧的hashtable保持只减不增，随着rehash的结束而消失。

  搬迁操作通过当前字典的后续操作触发的，并且Redis还会开启定时任务对字典进行主动搬迁。

### hash函数

  hashtable的性能好不好完全取决于hash函数的质量，一个好的hash函数可以将key打散的比较均匀。Redis中使用的hash函数是siphash。siphash算法 即使在输入的key非常小的情况下，也能产出随机性特别好的输出，而且它的性能也非常的突出。

  如果hash函数存在偏向性，那么就可能成为黑客攻击的漏洞，有限的服务器计算能力被hash的查找效率拖垮，这就是hash攻击。

### 何时扩容

  正常情况下，当hash中元素的个数等于数组的长度时，就会开始扩容，扩容的大小是原数组的两倍。特殊情况是，当Redis正在进行bgsave时，为了减少内存页的过多分离，Redis尽量不去扩容，如果链表上的元素已经是数组长度的5倍，那么Redis就会强制扩容。

### 何时缩容

  当hash表因为元素的删除变得稀疏时，Redis会减少hashtable中一维数组的大小。缩容的条件是链表上的元素的个数小于数组长度的 10%并且缩容不会考虑bgsave。  

### set结构

  set底层实现也是字典，只不过所有的value都为NULL。