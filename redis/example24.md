# 过期策略

  前面已经知道，对于Redis中的所有的key，都可以设置一个过期时期，那么我们就需要思考这一点：

  - 会不会因为过多的过期key导致Redis的性能下降

### 简介

  首先对于过期的key，Redis会单独放入一个集合中，进行定期处理和惰性处理

  - 定期处理： 定期的扫描过期字典。
  - 惰性处理： 客户端访问该key时，如果过期则立即删除。

### 定期扫描策略

  Redis默认每秒进行十次过期扫描，不是扫描所有的过期key，而是采用一种简单的贪心策略:

  - 1、从过期字典中随机拿出20个key。
  - 2、删除这20个key中已经过期的key。
  - 3、如果key过期的比例超过1/4，那么就重复步骤1。

  为了保证不出现扫描循环过度的情况，算法增加了时间限制，不会超过25ms。

  但是大规模的出现key过期的情况，仍然会出现卡顿情况：

  - Redis会持续的扫描过期字典，知道过期字典中已经过期的key变得稀疏。
  - 内存管理器不停的回收内存页，造成CPU消耗。

  所以当出现大规模key过期的情况，我们可以通过增加随机过期时间避免大规模key同时过期。

### 从库过期策略

  从库不会进行过期扫描，当主库的key到期的时候，会在AOF文件中添加一条del命令，从库通过这条指令删除过期的key。

  因为指令同步是异步进行的，这样就可能出现主从数据不一致的问题。