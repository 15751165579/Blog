# 复制

  在Redis的主从模式中，需要了解主从服务器是如何保持数据的一致性的。

### 主从服务器的配置

  对于主从服务器的配置可以通过slaveof命令，可以修改配置文件，也可以通过客户端执行。

### Redis2.8之前的从主同步策咯

  同步策咯采用SYNC方法：

  - 1）从服务器启动时，向主服务器请求同步。
  - 2）主服务器通过BGSAVE生成RDB文件，发送给从服务器。
  - 3）主服务器同时将这段时间缓冲区存放的写命令也发送给从服务器。
  - 4）从服务器载入RDB文件并且执行缓冲区的写命令，从而达到与主服务器一致的状态。
  - 5）接下来主服务器会通过命令传播的方式，将写命令同步给各个从服务器。

  这一切看起来都很完美，但是需要主从服务器断线的情况：

  - 从服务器只能通过再次向主服务器索要RDB文件，才能满足一致性的要求，这无形中浪费了很多资源。


### PSYNC

  Redis2.8之后采用了PSYNC方法实现主从的复制，分为完整同步操作与部分同步操作。

  完整同步操作基本上和之前的SYNC方法一样。

  而部分同步操作就是对之前主从服务器断线处理的优化。

##### 复制偏移量

  执行复制的主从服务器，都需要维护一个复制偏移量，也就是记录双方的状态是否一直并且不一致的区别在哪，从而明白改从哪里进行同步，而不是像之前那样重载RDB文件。

##### 复制积压缓冲区

  复制积压缓冲区是一个先进先出的队列，默认大小1M。

  当主服务器将写命令传播给从服务器时，同时还将写命令存储在复制积压缓冲区。

  当从服务器断线之后，PSYNC命令会将自己的复制偏移量发送给主服务器，这时主服务器会进行下列操作：

  - 1）如果复制偏移量之后的数据仍然在复制积压缓冲区中，那么主服务器直接将这部分命令发送给从服务器即可。
  - 2）否则，执行和完整同步一样的操作。

  通过配置文件可以灵活的改变复制积压缓冲区的大小，这里可以根据两个参数来估算它的大小：

  - second 从服务器断线重新连接上主服务器所需的平均时长（秒）
  - write_size_per_second 主服务器平均每秒产生的写命令（协议格式的长度总和）

```s
  2 * second * write_size_per_second
```

##### 服务器的运行ID

  主从服务器都有一个由40位的16进制字符随机组成的ID。

  当第一次从服务器同步时，主服务器会将ID发送给从服务器保存起来。当从服务器断线重连时，就会验证是不是自己之前连接的主服务器：

  - 如果ID一致，则可以进行部分同步操作。
  - 如果ID不一致，则直接载入主服务器的RDB文件。