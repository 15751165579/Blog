# 哈希表

### 基本实现

  Redis中的哈希表有以下几个属性：

  - table数组，用来存在dictEntry，dictEntry用来存在键值对。
  - size属性记录哈希表的大小。
  - used主要记录哈希表中节点的数目。
  - sizemask属性总是等于size - 1，它和哈希值一起决定键应该放在table中哪个索引上。

  哈希表节点dictEntry所包含的属性：

  - key用来保存键。
  - val用来保存值，但是这里得值可以采用指针或者不同类型的整形。
  - next指针指向另一个哈希表节点的指针，从而解决键冲突的问题。

### 字典

  Redis字典中的ht用来存放哈希表，ht包含两个哈希表，一般只用ht[0],ht[1]主要是用来处理rehash的情况。

  Redis中的哈希算法采用了MurmurHash2。

  前面说通过链表的结构解决键冲突的问题，这里采用的是单向链表并且没有记录尾节点，所以新元素会插在表头。

  rehash的过程：

  - 1）对于扩展和收缩多需要找到一个大小为第一个大于等于h[0].used * 2 的2次方的值。
  - 2）需要重新计算哈希值以及索引值，然后将ht[0]上的键值对迁移到ht[1]。
  - 3）当ht[0]所有的键值对迁移完毕之后，释放ht[0]，将ht[1]设置为ht[0], 重新创建一个空的ht[1]，为下一次rehash做准备。


  这里需要记住一个哈希表的负载因子：

```s
  load_fator = ht[0].used / ht[0].size
```

  对于Redis不仅仅需要执行rehash操作，还有一些其他的费时操作如：BGSAVE、BGREWRITEAOF。

  - 当这两个操作没有执行并且负载因子大于1，那么执行rehash操作。
  - 当这两个操作执行时并且负载因子大于5，那么也执行rehash操作。


  如果哈希表非常非常的大，那么会非常的耗时，为了不影响性能，作者推出了渐进式rehash操作：

  - 为ht[1]分配空间，让字典同时持有ht[0]和ht[1]
  - 字典中维护一个rehashidx，设置为0表示rehash操作正在执行。
  - 在rehash操作期间，对字典的添加、删除、查找或者更新操作，需要顺带将ht[0]上的键值对迁移到ht[1]上，当rehash完成之后，将rehashidx值自增一。
  - 随着时间的不断进行，最终会完全的完成rehash操作，这时将rehashidx设置为-1，表示操作完成。

  通过rehash的方式避免集中式的rehash带来的性能问题。

