# 主从同步

### 分布式系统的理论基石-CAP原理

  - C: Consistent(一致性)
  - A: Availability(可用性)
  - P: Partition tolerance(分区容忍性)

  分布式系统节点往往分布在不同的机器上，这必然存在网络断开的风险，这种场景的专业名词叫做【网络分区】。 

  当网络分区发生时，一致性和可用性无法同时满足。

### Redis中的处理

  Redis分布式满足可用性，对于一致性，从节点在网络恢复后通过各种策略努力追赶上落后的数据。

### 增量同步

  主节点会将修改操作的指令记录在内存buffer中，异步的将buffer同步到从节点。

  因为内存的buffer是有限的，所以Redis主库不能讲所有的指令都记录在内存buffer中。Redis的复制内存Buffer是一个定长的环形数组，如果内容满了，则从头开始复制。

  如果由于网络断开过长，就不能完全使用增量同步，这时需要采用快照同步。

### 快照同步

  快照同步是一个非常耗费资源的操作。首先主库上进行一次bgsave将当期内存的数据全部快照到磁盘文件中，然后再将全部快照传送到从节点，从节点接收到，进行全量加载（首先清除当期内存），加载完之后通知主节点进行增量同步。

  但是在这样的情况下，如果同步时间过长，或者复制的buffer过小，那么从节点还是会请求主节点进行快照同步，那很有可能陷入快照同步的死循环，那么我们就需要合理的设置Buffer的大小。

### 增加从节点

  当从节点加入到集群中，它必须先进行一次快照同步，再进行增量同步。

### 无盘复制

  主节点进行快照同步时，会进行很重的文件IO操作，影响主节点的效率。

  Redis2.8支持无盘复制，也就是通过套接字不断的获取到快照内容存储到磁盘文件，再进行一次性加载。

### wait指令

  Redis3.0提供wait指令

```s
  # 从库数量 等待时间
  wait 1 0
```

  通过该指令可以将异步复制变身为同步复制。

  但是这里要注意的是：当你执行该命令时，出现网络分区，那么主节点的服务不再可用。