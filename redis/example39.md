# 探索HyperLogLog内部

  HyperLogLog算法是一种非常巧妙的近似统计海量去重元素数量的算法。它内部维护了16384个桶来记录各个桶的元素数量。

  当一个元素到来，会被散列到其中一个桶，以一定的概率影响这个桶的计数值。因为是概率算法，所以单个桶的计数值并不准确，但是所有桶计数值进行均值累加，则非常接近真实的计数值。

### 存储

  如果准确去重的话，我们会使用set，然后通过scard获取元素的个数。

  因为单个集合会非常的大，所以将集合打散成16384个小集合，通过hash算法分配到各个小集合，但是集合打散并没有减少内存的占用。

  HyperLogLog每个桶实际上只占6bit，它记录的是桶中元素的对数值。

  实际上一个HyperLogLog占据的空间(16384 * 6 / 8)12k，对于数据非常少的情况下，作者肯定不能容忍空间的浪费。这里就有了稀疏存储和密集存储。

  密集存储会占据12K字节，结构非常的简单就是连续16384个6bit串成的字符串位图。

### 存储转化

  通过设置阈值：

```s
  hll_sparse_max_bytes
```